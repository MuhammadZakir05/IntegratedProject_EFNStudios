<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Scam Awareness Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="page">
        <div class="profile-header">
            <a href="dashboard.html" class="back-btn">
                <svg class="icon" viewBox="0 0 24 24">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                <span>Back</span>
            </a>

            <div class="text-center">
                <div class="profile-avatar" id="profile-avatar">U</div>
                <h1 class="mb-1" id="profile-name">User</h1>
                <p class="text-sm text-gray">Scam Awareness Champion</p>
            </div>

            <div class="stats-grid mt-6">
                <div class="stat-card">
                    <p class="stat-value text-blue" id="profile-achievements">0</p>
                    <p class="stat-label">Achievements</p>
                </div>
                <div class="stat-card">
                    <p class="stat-value text-green" id="profile-scenarios">0</p>
                    <p class="stat-label">Scenarios</p>
                </div>
                <div class="stat-card">
                    <p class="stat-value text-yellow" id="profile-trophies">0</p>
                    <p class="stat-label">Trophies</p>
                </div>
            </div>
        </div>

        <div class="container">
            <h2 class="mb-4">Master Trophy</h2>
            <div class="trophy-card" id="trophy-card">
                </div>

            <h2 class="mb-4 mt-8">Badges</h2>
            <div class="badges-grid" id="badges-container"></div>

            <h2 class="mb-4 mt-8">Milestones</h2>
            <div id="milestones-container">
                </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Check Login
        const currentUser = getCurrentUser();
        if (!currentUser) window.location.href = 'login.html';

        // Load Stats
        const achievements = getAchievements();
        const scenarios = getCompletedScenarios();

        // Update Header
        const avatar = document.getElementById('profile-avatar');
        const name = document.getElementById('profile-name');
        
        if (currentUser) {
            avatar.textContent = (currentUser.fullName || currentUser.username || 'U')[0].toUpperCase();
            name.textContent = currentUser.fullName || currentUser.username || 'User';
        }

        const badgeCount = getAchievementCount();
        const trophyCount = achievements.master_trophy ? 1 : 0;

        document.getElementById('profile-achievements').textContent = badgeCount;
        document.getElementById('profile-scenarios').textContent = scenarios.length;
        document.getElementById('profile-trophies').textContent = trophyCount;

        // --- 1. TROPHY LOGIC (Top Card - Claim System) ---
        const trophyCard = document.getElementById('trophy-card');
        const isUnlocked = achievements.master_trophy;
        const isClaimed = localStorage.getItem('trophyClaimed') === 'true';
        const trophyTotal = 7; 
        const currentProgress = badgeCount;
        const trophyPct = Math.min((currentProgress / trophyTotal) * 100, 100);

        if (isUnlocked) {
            if (isClaimed) {
                // CLAIMED: Show Trophy Model
                trophyCard.classList.add('unlocked');
                trophyCard.style.padding = "0";
                trophyCard.style.overflow = "hidden";
                trophyCard.innerHTML = `
                    <div style="position: relative; width: 100%; height: 320px;">
                        <iframe title="Master Protector" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share src="https://sketchfab.com/models/beb3de83add44d0faa93f59583492ab2/embed?autostart=1&ui_controls=0&ui_infos=0&ui_inspector=0&ui_watermark=0&transparent=1" style="width: 100%; height: 100%; border: none;"></iframe>
                        <div style="position:absolute; bottom:0; left:0; width:100%; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding:20px; pointer-events:none;">
                            <h3 style="color: #facc15; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Master Protector</h3>
                            <p class="text-sm text-gray mt-1">You are a certified scam expert!</p>
                        </div>
                    </div>
                `;
            } else {
                // UNLOCKED: Show Claim Button
                trophyCard.classList.add('unlocked');
                trophyCard.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <h3 style="color: #facc15; margin-bottom: 0.5rem;">Trophy Unlocked!</h3>
                        <p class="text-sm text-gray mb-4">You have completed all training modules.</p>
                        <button class="btn btn-primary" onclick="claimTrophy()" style="background: linear-gradient(to right, #facc15, #eab308); color: black; font-weight: bold; border: none;">CLAIM REWARD üéÅ</button>
                    </div>
                `;
            }
        } else {
            // LOCKED: Show Progress
            trophyCard.innerHTML = `
                <div class="trophy-content">
                    <div class="trophy-icon" id="trophy-icon"><svg class="icon" viewBox="0 0 24 24" style="color: #6b7280;"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg></div>
                    <div style="flex: 1;">
                        <div class="flex items-center gap-2 mb-1"><h3 id="trophy-title">Master Protector</h3></div>
                        <p class="text-sm text-gray mb-3">Unlock all achievements to claim</p>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span class="text-gray">Progress</span><span class="text-gray">${currentProgress}/${trophyTotal}</span></div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${trophyPct}%"></div></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function claimTrophy() {
            localStorage.setItem('trophyClaimed', 'true');
            window.location.reload(); 
        }

        // --- 2. BADGES (Standard) ---
        const allBadges = [
            { id: 'first_scenario', title: 'First Steps', description: 'Complete your first scenario', unlocked: achievements.first_scenario || false },
            { id: 'telegram_master', title: 'Telegram Defender', description: 'Complete the Telegram scenario', unlocked: scenarios.includes('telegram-scam') },
            { id: 'job_hunter', title: 'Job Scam Detective', description: 'Complete the Job scenario', unlocked: scenarios.includes('job-scam') },
            { id: 'bank_guardian', title: 'Banking Guardian', description: 'Complete the Bank scenario', unlocked: scenarios.includes('bank-phishing') },
            { id: 'knowledge_seeker', title: 'Knowledge Seeker', description: 'Read the Scampedia', unlocked: achievements.scampedia_visited || false },
            { id: 'aware_citizen', title: 'Aware Citizen', description: 'View the Scam Impact page', unlocked: achievements.scam_impact_visited || false }
        ];

        const badgesContainer = document.getElementById('badges-container');
        badgesContainer.innerHTML = '';
        allBadges.forEach(badge => {
            const badgeCard = document.createElement('div');
            badgeCard.className = 'badge-card' + (badge.unlocked ? ' unlocked' : '');
            badgeCard.innerHTML = `
                <div class="badge-icon-small ${badge.unlocked ? 'unlocked' : ''}">
                    <svg class="icon" viewBox="0 0 24 24" style="color: ${badge.unlocked ? 'white' : '#6b7280'};">
                        ${badge.unlocked ? '<circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>' : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>'}
                    </svg>
                </div>
                <h4 style="color: ${badge.unlocked ? 'white' : '#6b7280'};">${badge.title}</h4>
                <p class="text-xs text-gray mt-1">${badge.description}</p>
            `;
            badgesContainer.appendChild(badgeCard);
        });

        // --- 3. MILESTONE: SCENARIO MASTER (Medal Model) ---
        const milestone = {
            title: 'Scenario Master',
            description: 'Complete all three scenarios',
            unlocked: scenarios.length >= 3
        };

        const milestonesContainer = document.getElementById('milestones-container');
        
        if (milestone.unlocked) {
            // UNLOCKED: Show Medal 3D Model
            milestonesContainer.innerHTML = `
                <div class="badge-card unlocked" style="border-radius: 1rem; overflow: hidden; padding: 0;">
                    <div style="position: relative; width: 100%; height: 300px;">
                        <iframe 
                            title="Scenario Master Medal" 
                            frameborder="0" 
                            allowfullscreen 
                            mozallowfullscreen="true" 
                            webkitallowfullscreen="true" 
                            allow="autoplay; fullscreen; xr-spatial-tracking" 
                            xr-spatial-tracking 
                            execution-while-out-of-viewport 
                            execution-while-not-rendered 
                            web-share 
                            src="https://sketchfab.com/models/d07b43d11c574df698c50598dfb97544/embed?autostart=1&ui_controls=0&ui_infos=0&ui_inspector=0&ui_watermark=0&transparent=1" 
                            style="width: 100%; height: 100%; border: none;">
                        </iframe>
                        <div style="position:absolute; bottom:0; left:0; width:100%; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding:20px; pointer-events:none;">
                            <h4 style="color: #fbbf24; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Scenario Master</h4>
                            <p class="text-sm text-gray mt-1">You defended against all threats!</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // LOCKED: Show Standard Icon
            milestonesContainer.innerHTML = `
                <div class="badge-card" style="border-radius: 1rem;">
                    <div class="flex items-center gap-4">
                        <div class="badge-icon-small" style="width: 3.5rem; height: 3.5rem;">
                            <svg class="icon" viewBox="0 0 24 24" style="color: #6b7280;">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="color: #6b7280;">${milestone.title}</h4>
                            <p class="text-sm text-gray mt-1">${milestone.description}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>