<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEFN - Mission</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="simulator-wrapper">
        <div class="phone-frame">
            <div class="notch"></div>
            <div class="app-header">
                <button class="back-btn" onclick="location.href='home.html'"><i class="fas fa-chevron-left"></i> Home</button>
                <span style="font-weight:bold">ChatZap</span>
                <span style="font-size:0.7rem; background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:4px;">SECURE</span>
            </div>
            <div class="game-hud">
                <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:#aaa;">
                    <span>BALANCE</span>
                    <span id="money-display" style="color:#22c55e; font-weight:bold;">Loading...</span>
                </div>
            </div>
            <div id="chat-window" class="chat-area">
                <div class="system-msg">Scanning encrypted channel...</div>
            </div>
            <div id="choices-area" class="input-area">
                <button class="game-btn btn-action" onclick="startGame()">INITIALIZE SCAN</button>
            </div>
        </div>
    </div>

    <script src="db.js"></script>
    <script src="scenarios.js"></script>
    <script>
        const chat = document.getElementById('chat-window');
        const choices = document.getElementById('choices-area');
        let currentLevel = 0;

        async function updateUI() {
            let data = await DB.getData();
            if(data) {
                document.getElementById('money-display').innerText = "$" + data.balance.toLocaleString();
                if(data.balance < 3000) document.getElementById('money-display').style.color = "#ef4444";
            }
        }

        async function startGame() {
            await updateUI();
            choices.innerHTML = ''; 
            loadLevel(0);
        }

        function loadLevel(index) {
            if(index >= scenarios.length) {
                choices.innerHTML = `<button class="game-btn btn-neutral" onclick="location.href='home.html'">MISSION COMPLETE</button>`;
                return;
            }
            let level = scenarios[index];
            addMessage("system-msg", `INCOMING: ${level.sender.toUpperCase()}`);
            setTimeout(() => {
                addMessage("bot", level.message);
                setTimeout(() => {
                    addMessage("bot", level.followUp);
                    showChoices(level);
                }, 1000);
            }, 800);
        }

        function showChoices(level) {
            let c = level.options.find(o => o.type === "correct");
            let w = level.options.find(o => o.type === "wrong");
            let t = level.options.find(o => o.type === "troll");

            choices.innerHTML = `
                <button class="game-btn btn-neutral" onclick="handleReply(${currentLevel}, 'correct')">${c.text}</button>
                <button class="game-btn btn-action" style="margin-top:10px; background:#ef4444;" onclick="handleReply(${currentLevel}, 'wrong')">${w.text}</button>
                <button class="game-btn btn-action" style="margin-top:10px; background:#8b5cf6;" onclick="handleReply(${currentLevel}, 'troll')">${t.text}</button>
            `;
        }

        async function handleReply(idx, type) {
            let choice = scenarios[idx].options.find(o => o.type === type);
            addMessage("user", choice.reply);
            choices.innerHTML = '';

            setTimeout(async () => {
                addMessage("bot", choice.botResponse);
                if(type === 'wrong') {
                    addMessage("system-msg", "UNAUTHORIZED TRANSACTION DETECTED");
                    await DB.addTransaction(`Scam: ${scenarios[idx].sender}`, choice.cost);
                    await updateUI();
                } else if(type === 'troll') {
                    addMessage("system-msg", "TROLL SUCCESSFUL (XP +100)");
                } else {
                    addMessage("system-msg", "THREAT BLOCKED");
                }
                
                setTimeout(() => {
                    currentLevel++;
                    if(currentLevel < scenarios.length) {
                        choices.innerHTML = `<button class="game-btn btn-action" onclick="loadLevel(${currentLevel})">NEXT SCENARIO</button>`;
                    } else {
                        choices.innerHTML = `<button class="game-btn btn-neutral" onclick="location.href='home.html'">MISSION COMPLETE</button>`;
                    }
                }, 1500);
            }, 800);
        }

        function addMessage(type, text) {
            let div = document.createElement('div');
            div.className = type === "system-msg" ? "system-msg" : `msg ${type}`;
            div.innerText = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        updateUI();
    </script>
</body>
</html>