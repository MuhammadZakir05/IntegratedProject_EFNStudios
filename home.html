<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app-frame">
        <div id="app-content">
            <div class="header">
                <span>Dashboard</span>
                <i class="fas fa-shield-alt" style="color:#fff;"></i>
            </div>
            
            <div class="card" style="background:#111; border:1px solid #333; padding:25px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px;">
                    <div>
                        <div style="color:#888; font-size:0.85rem; margin-bottom:5px;">Balance</div>
                        <div id="bal" style="font-size:2rem; font-weight:bold; color:white;">Loading...</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:#888; font-size:0.85rem; margin-bottom:5px;">Lost</div>
                        <div id="lost" style="font-size:1.5rem; font-weight:bold; color:#ef4444;">...</div>
                    </div>
                </div>
            </div>

            <a href="simulation.html" class="card" style="display:flex; align-items:center; gap:15px; text-decoration:none; color:white; cursor:pointer; padding:20px;">
                <div style="width:50px; height:50px; background:white; border-radius:12px; display:flex; align-items:center; justify-content:center; color:black; font-size:1.2rem;">
                    <i class="fas fa-play"></i>
                </div>
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">Start</div>
                    <div style="color:#888; font-size:0.8rem;">Simulation</div>
                </div>
            </a>

            <a href="scampedia.html" class="card" style="display:flex; align-items:center; gap:15px; text-decoration:none; color:white; cursor:pointer; padding:20px;">
                <div style="width:50px; height:50px; background:#222; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-size:1.2rem;">
                    <i class="fas fa-book"></i>
                </div>
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">Scampedia</div>
                    <div style="color:#888; font-size:0.8rem;">Learn</div>
                </div>
            </a>

            <h3 style="margin-top:25px; margin-bottom:15px;">History</h3>
            <div id="history-list">
                </div>

            <div style="margin-top:30px; text-align:center;">
                <button onclick="DB.repairAccount()" style="background:transparent; border:1px solid #333; color:#666; padding:10px 20px; border-radius:20px; font-size:0.8rem; cursor:pointer;">
                    Fix / Reset My Data
                </button>
            </div>
            <div style="height:50px;"></div>
        </div>

        <div class="nav-bar">
            <a href="home.html" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="simulation.html" class="nav-item"><i class="fas fa-gamepad"></i><span>Sim</span></a>
            <a href="scampedia.html" class="nav-item"><i class="fas fa-book"></i><span>Learn</span></a>
            <a href="profile.html" class="nav-item"><i class="fas fa-user"></i><span>Profile</span></a>
        </div>
    </div>

    <script src="db.js"></script>
    <script>
        async function loadDashboard() {
            let user = await DB.getUser();
            if(!user) { window.location.href = 'index.html'; return; }

            // 1. Safe Math
            let start = user.startBalance || 5000;
            let current = user.balance !== undefined ? user.balance : 5000;
            let lostAmount = start - current;

            // 2. Update UI
            document.getElementById('bal').innerText = `$${current.toLocaleString()}`;
            document.getElementById('lost').innerText = `-$${lostAmount.toLocaleString()}`;

            // 3. Render History
            let list = document.getElementById('history-list');
            list.innerHTML = ''; 

            if(!user.history || !Array.isArray(user.history) || user.history.length === 0) {
                list.innerHTML = `<div style="text-align:center; color:#444; padding:20px;">No activity yet.</div>`;
            } else {
                user.history.forEach(h => {
                    let isSafe = h.status === 'passed';
                    let color = isSafe ? '#22c55e' : '#ef4444';
                    let icon = isSafe ? 'fa-check' : 'fa-times';
                    let title = h.levelId ? h.levelId.replace('_', ' ').toUpperCase() : 'SCENARIO';

                    list.innerHTML += `
                        <div class="card" style="display:flex; align-items:center; justify-content:space-between; padding:15px; margin-bottom:10px;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div style="width:40px; height:40px; background:#1a1a1a; border-radius:10px; display:flex; align-items:center; justify-content:center; color:${color};">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div>
                                    <div style="font-weight:bold; font-size:0.85rem;">${title}</div>
                                    <div style="color:#555; font-size:0.7rem;">${h.date || 'Today'}</div>
                                </div>
                            </div>
                            <div style="font-weight:bold; color:${color};">
                                ${h.cost > 0 ? '-$'+h.cost : 'Safe'}
                            </div>
                        </div>
                    `;
                });
            }
        }
        loadDashboard();
    </script>
</body>
</html>